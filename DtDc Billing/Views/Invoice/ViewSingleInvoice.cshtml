@model IEnumerable<DtDc_Billing.Entity_FR.Invoice>

@{
    /**/

    ViewBag.Title = "ViewSingleInvoice";
    Layout = "~/Views/Shared/AdminLayout.cshtml";
}



<link href="~/admin-lte/bower_components/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css" rel="stylesheet" />
<script src="~/admin-lte/bower_components/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .select2-container {
        width: 100% !important;
    }

    .select2-selection--single {
        height: 38px !important;
        padding: 6px 12px !important;
    }

    .select2-selection__rendered {
        line-height: 26px !important;
    }

    .select2-container {
        width: 100% !important;
    }

    .select2-search--inline .select2-search__field {
        width: 115em !important; /* Adjust width */
    }

    .select2-selection--multiple {
        min-height: 38px;
    }
</style>

<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
    .Viewsingleinvoice th {
        width: 7.14% !important
    }

    .status-button {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: bold;
        text-align: center;
        transition: background-color 0.3s, transform 0.3s;
    }

    .btn-success {
        background-color: #28a745; /* Green */
        color: white;
        align-content: center;
        justify-content: center;
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        font-size: 14px;
        border-left: 6px solid #28a745;
        border-top: 1px solid #f39c12;
        margin: 20px 20px 20px 30px !important;
        transition: transform 0.2s ease; /* Add a hover effect */
        border-radius: 50px; /* Make corners circular */
    }

    .btn-danger {
        background-color: #dc3545; /* Red */
        color: white;
        align-content: center;
        justify-content: center;
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        font-size: 14px;
        border-top: 1px solid #dc2a4b;
        margin: 20px 20px 20px 30px !important;
        transition: transform 0.2s ease; /* Add a hover effect */
        border-radius: 50px; /* Make corners circular */
    }

    .btn-warning {
        background-color: #ffc107; /* Yellow */
        color: black;
        align-content: center;
        justify-content: center;
        font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
        font-size: 14px;
        border-top: 1px solid #ffc107;
        margin: 20px 20px 20px 30px !important;
        transition: transform 0.2s ease; /* Add a hover effect */
        border-radius: 50px; /* Make corners circular */
    }

    .status-button:hover {
        transform: scale(1.05); /* Slightly enlarge the button on hover */
    }

    .status-button:active {
        transform: scale(0.95); /* Slightly shrink the button when clicked */
    }
</style>
<!-- Main content -->

<div class="content-wrapper">
    <div class="box box-info" style="padding: 16px 16px !important">
        <div class="box-header with-border">
            <h4>
                VIEW SINGLE INVOICE
                <a href="https://www.youtube.com/watch?v=_5jj1ozy0I0&list=PLT-Gd9X3Y1afr1FZRb8Z8ELFncnWwOhzz&index=27"
                   target="_blank"
                   data-toggle="tooltip"
                   title="Click to view more info">
                    <i class="fa fa-info-circle" style="font-size:25px;"></i>
                </a>
            </h4>

        </div>
        <!-- /.box-header -->
        <div class="box-body">
            @{
                var successMessage = @TempData["success"] as string;
                var errorMessage = TempData["error"] as string;
            }

            @if (!string.IsNullOrEmpty(successMessage))
            {
                @Html.Partial("~/Views/Shared/AlertPartial.cshtml", new Tuple<string, string>("success", successMessage))
            }
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                @Html.Partial("~/Views/Shared/AlertPartial.cshtml", new Tuple<string, string>("danger", successMessage))

            }
            <div class="row">
                <div class="col-12 col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    @*@Html.Partial("GetInvoiceDataForDashboard", "Invoice", (DtDc_Billing.Models.InvoiceDataForDashBoard)@ViewBag.DataPoints))*@
                    @Html.Partial("GetInvoiceDataForDashboard")
                </div>
            </div>
            <div class="row">



                @using (Html.BeginForm("ViewSingleInvoice", "Invoice", FormMethod.Get, new { id = "FormSubmitSingle" }))
                {


                    if (ViewBag.Companydetails != null)
                    {
                        <div class="col-md-3" style="margin-top:10px;padding-left:0">

                            <label>Company Name</label>
                            <select name="Companydetails" id="Companydetails" class="form-control" multiple="multiple">

                                @if (ViewBag.CompanyList != null)
                                {
                                    foreach (var icom in ViewBag.CompanyList)
                                    {
                                        <option value="@icom" selected>@icom</option>

                                    }
                                }

                            </select>
                            @*<input type="text" name="Companydetails" id="Companydetails" class="form-control" value="@ViewBag.Companydetails">*@

                            @*@Html.DropDownList("Companydetails", "-Please select-")*@

                        </div>
                    }
                    else
                    {
            <div class="col-md-3" style="margin-top:10px;padding-left:0">

                <label>Company Name</label>

                @*<input type="text" name="Companydetails" id="Companydetails" class="form-control">*@

                <select name="Companydetails" id="Companydetails" class="form-control" multiple="multiple">

                    @if (ViewBag.CompanyList != null)
                    {
                        foreach (var icom in ViewBag.CompanyList)
                        {
                            <option value="@icom" selected>@icom</option>

                        }
                    }

                </select>
                @*@Html.DropDownList("Companydetails", "-Please select-")*@

            </div>
                    }
                    if (ViewBag.invoiceNo != null)
                    {
                        <div class="col-md-3" style="margin-top:10px;padding-left:0">

                            <label>Invoice Number</label>

                            <input type="text" name="invoiceNo" id="invoiceNo" class="form-control" value="@ViewBag.invoiceNo">

                            @*@Html.DropDownList("Companydetails", "-Please select-")*@

                        </div>
                    }
                    else
                    {
                        <div class="col-md-3" style="margin-top:10px;padding-left:0">

                            <label>Invoice Number</label>

                            <input type="text" name="invoiceNo" id="invoiceNo" class="form-control">

                            @*@Html.DropDownList("Companydetails", "-Please select-")*@

                        </div>
                    }
                    if (ViewBag.fromdate != null)
                    {
                        <div class="col-md-2" style="margin-top: 10px; padding-left: 0">
                            <label>From Date</label>
                            @*<label class="Reqired">*</label>*@
                            <input type="text" name="invfromdate" id="invfromdate" class="form-control" value="@ViewBag.fromdate">
                        </div>
                    }
                    else
                    {
                        <div class="col-md-2" style="margin-top: 10px; padding-left: 0">
                            <label>From Date</label>
                            @*<label class="Reqired">*</label>*@
                            <input type="text" name="invfromdate" id="invfromdate" class="form-control">
                        </div>
                    }
                    if (ViewBag.todate != null)
                    {
                        <div class="col-md-2" style="margin-top: 10px; padding-left: 0">
                            <label>To Date</label>
                            @*<label class="Reqired">*</label>*@
                            <input type="text" name="invtodate" id="invtodate" class="form-control" value="@ViewBag.todate">
                        </div>
                    }
                    else
                    {
                        <div class="col-md-2" style="margin-top: 10px; padding-left: 0">
                            <label>To Date</label>
                            @*<label class="Reqired">*</label>*@
                            <input type="text" name="invtodate" id="invtodate" class="form-control">
                        </div>
                    }




                    <input type="hidden" value="@ViewBag.firmid">
                    <input type="hidden" value="@ViewBag.Companyid">

                    @*  @Html.HiddenFor(m => m.Firm_Id, new { @Value = ViewBag.firmid })*@

                    <div class="col-md-1" style="padding:0">
                        <input type="submit" class="btn btn-primary sbmt" name="submit" id="submitbook" value="Submit" style="margin:33px auto;width:100%" />
                    </div>

                    <br /><br /><br /><br />

                }
                <div class="col-xs-12">

                    @*<div class="col-md-4">
                            <label for="departmentsDropdown">Firm Name</label>
                            <select class="form-control" id="departmentsDropdown" name="departmentsDropdown"></select>
                        </div>*@
                    <table id="table_display_block" class="table Viewsingleinvoice">
                        <thead>
                            <tr>
                                <th></th>
                                @*<th></th>*@
                                <th>
                                    @Html.DisplayNameFor(model => model.invoiceno)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.invoicedate)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.Customer_Id)
                                </th>

                                <th>
                                    @Html.DisplayNameFor(model => model.periodfrom)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.periodto)
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.total)
                                </th>
                                <th>
                                    @*@Html.DisplayNameFor(model => model.fullsurchargetax)*@  FuelSurchargetax(%)
                                </th>
                                <th>
                                    @*@Html.DisplayNameFor(model => model.fullsurchargetaxtotal)*@ FuelSurchargetax Total
                                </th>
                                <th>
                                    Discount(%)
                                </th>
                                <th>Discount Amount</th>
                                <th>
                                    GST(%)
                                </th>
                                <th>
                                    GST Amount
                                </th>
                                <th>
                                    @Html.DisplayNameFor(model => model.othercharge)
                                </th>
                                <th>
                                    @*@Html.DisplayNameFor(model => model.netamount)*@  Net Amount
                                </th>
                                <th>Paid Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td>
                                        @*@Html.ActionLink("View", "ReportsinglePrinterMethod", new { myParameter = item.invoiceno }) |*@
                                        <div style="display:flex; gap:5px;">
                                            <a class="view-btn" href="@Url.Action("Download","Invoice",new {id = item.IN_Id })" target="_blank">View</a>
                                            @Html.ActionLink("Edit", "GenerateInvoiceSingle", new { Invoiceno = item.invoiceno, Firm_Id = item.Firm_Id }, new { @class = "edit-btn" })
                                            @*</td>
        <td>*@
                                            @Html.ActionLink("Delete", "DeleteSingleInvoice", "Invoice", new
                                       {
                                           invoiceid = item.IN_Id,
                                           invoiceNo = item.invoiceno,
                                           invfromdate = ViewBag.fromdate,
                                           Companydetails = ViewBag.Companydetails,
                                           invtodate = ViewBag.todate,
                                       }, new
                                       {
                                           onclick = "return confirm('Are you sure you want to delete this invoice? This action is permanent, and the invoice will be permanently deleted.')",
                                           @class = "delete-btn",
                                           @style = "margin-bottom:50px;"

                                       })

                                        </div>
                                      
                                        @*@Html.ActionLink("Delete", "DeleteSingleInvoice", "Invoice", new { invoiceid = item.IN_Id, invfromdate = ViewBag.invfromdate, Companydetails = ViewBag.Companydetails, invtodate = ViewBag.invtodate }, new { onclick = "return confirm('Are you sure you want to delete this invoice? Please note that this invoice number cannot be reused in the future, and all associated payment details will be permanently deleted.')", @class = "delete-btn" })*@
                               

                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.invoiceno)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.tempInvoicedate)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.Customer_Id)
                                    </td>

                                    <td>
                                        @Html.DisplayFor(modelItem => item.Tempdatefrom)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.TempdateTo)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.total)
                                    </td>
                                    <td>
                                        @(item.fullsurchargetax!=null?item.fullsurchargetax:0)
                                    </td>
                                    <td>
                                        @(item.fullsurchargetaxtotal!=null?item.fullsurchargetaxtotal:0)
                                    </td>
                                    <td>
                                        @( item.discountper!=null?item.discountper:0)
                                    </td>
                                    <td>
                                        @( item.discountamount!=null?item.discountamount:0)
                                    </td>
                                    <td>
                                        @(item.servicetax!=null?item.servicetax:0)
                                    </td>
                                    <td>
                                        @( item.servicetaxtotal!=null? item.servicetaxtotal:0)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.othercharge)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.netamount)
                                    </td>
                                    <td>@(item.paid!=null?item.paid:0)  </td>
                                    <td>
                                        @if (item.paid >= item.netamount)
                                        {
                                            <span class="btn btn-success status-button">Paid</span>
                                        }
                                        else if (item.paid == null || item.paid == 0)
                                        {
                                            <span class="btn btn-danger status-button">Unpaid</span>
                                        }
                                        else if (item.paid != null && item.paid < item.netamount)
                                        {
                                            <span class="btn btn-warning status-button">Partial Paid</span>
                                        }
                                    </td>

                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <!-- /.box-body -->
            </div>
            <!-- /.box -->
        </div>
        <!-- /.col -->
    </div>
    <!-- /.row -->
    <!-- /.content -->
</div>

<script>
    $('#invfromdate').datepicker({
        autoclose: true,
        format: 'dd-mm-yyyy'
    })

    $('#invtodate').datepicker({
        autoclose: true,
        format: 'dd-mm-yyyy'
    })

    $(function () {

        $('#table_display_block').dataTable({
            "bPaginate": true,
            "bLengthChange": true,
            "bFilter": true,
            "bSort": true,
            "bInfo": true,
            "bAutoWidth": true
        });


    });
</script>


<script>
    var availableinvoicesarr = [];
    var availableTutorials = [];
    var company_idarr = [];
/////Sender Autocomplete
@*$(function () {


    $.ajax({
        type: 'GET',
                url: '@Url.Action("CustomerIdAutocompleteForViewInvocie")',
        data: { },
        dataType: 'json',
        success: function(data) {
            $.each(data, function(i, item) {
                        company_idarr.push(item.Company_Id);
            });
                }
            });

    $("#Companydetails").autocomplete({
        source: company_idarr,
select: function(event, ui) {
    $("#Companydetails").val(ui.item.value);

    $("#Companydetails").trigger("focusout");
        }
    });

    //$("#Companydetails").autocomplete({
    //    source: company_idarr,
    //    select: function(event, ui) {

    //    }
    //});
});*@



$(function () {
    // Fetch data via AJAX
    $.ajax({
        type: 'GET',
        url: '@Url.Action("CustomerIdAutocompleteForViewInvocie")',
        dataType: 'json',
        success: function (data) {
            var companySelect = $('#Companydetails');
            companySelect.empty(); // Clear existing options

            // Populate the dropdown with only Company_Id
            $.each(data, function (i, item) {
                companySelect.append(
                    $('<option>', {
                        value: item.Company_Id,
                        text: item.Company_Id
                    })
                );
            });

             // Get selected company IDs from ViewBag
            var selectedCompanies = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.CompanyList ?? new List<string>()));

            // Preselect options based on ViewBag.CompanyList
            companySelect.val(selectedCompanies).trigger('change');
            // Initialize Select2
            companySelect.select2({
                placeholder: "Select Companies",
                allowClear: true,
                width: '125px',
                multiple: true // Allow multiple selections
            });
        },
        error: function (xhr, status, error) {
            console.error('Failed to fetch company data:', error);
        }
    });

    // Handle selection change
    $('#Companydetails').on('change', function () {
        var selectedCompanies = $(this).val(); // Get all selected values
        console.log('Selected Companies:', selectedCompanies);
    });
});
    $('#Companydetails').focusout(function () {
        var Customerid = $('#Companydetails').val();
        if (Customerid.length >= 3) {
            $.ajax({
                type: 'Get',
                dataType: 'json',
                url: '/Booking/Checkcompany',
                data: { Customerid: Customerid },
                success: function (Data) {

                    if (Data == "0") {
                        alert("Please Enter Valid Company Id");
                        $('#Companydetails').val('');
                    }



                }
            });
        }
    });


    $(function () {

          $.ajax({
      type: 'GET',
      url: '@Url.Action("InvoiceNumberAutocompleteForViewInvocie")',
              data: { Customer_Id:null},
      dataType: 'json',
              success: function (data) {

          $.each(data, function (i, item) {
              availableinvoicesarr.push(item.invoiceno);
          })
      }
  });
  //      $("#invoiceno").autocomplete({
  //          source: availableinvoicesarr,
  //          select: function (event, ui) {
  //              $("#invoiceno").val(ui.item.value);
  //              $("#invoiceno").trigger("focusout")
  //          }
  //      });
        $("#invoiceno").autocomplete({
            source: availableinvoicesarr,
          select: function (event, ui) {
              $("#invoiceno").val(ui.item.value);

              $("#invoiceno").trigger("focusout");
          }
      });
    })

</script>

<script>
    $(document).ready(function () {
        var availableinvoicesarr = [];

        $('#Companydetails').change(function () {
            var Customerid = $('#Companydetails').val();

            // Check if Customer ID is valid
            if (Customerid.length >= 3) {
                availableinvoicesarr = []; // Reset the array before new fetch

                $.ajax({
                    type: 'GET',
                    dataType: 'json',
                    url: '/Invoice/InvoiceNumberAutocompleteForViewInvocie',
                    data: { Customer_Id: Customerid },
                    success: function (Data) {
                        // Populate the array with the fetched invoice numbers
                        $.each(Data, function (i, item) {
                            availableinvoicesarr.push(item.invoiceno);
                        });

                        // Reinitialize autocomplete after data is loaded
                        initializeAutocomplete();
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching invoice numbers:', error);
                    }
                });
            }
        });

        // Focusout event to clear suggestions
        $("#invoiceno").focusout(function () {
            availableinvoicesarr = [];
            initializeAutocomplete();
        });

        // Function to initialize autocomplete
        function initializeAutocomplete() {
            $("#invoiceno").autocomplete({
                source: availableinvoicesarr,
                select: function (event, ui) {
                    $("#invoiceno").val(ui.item.value);
                    $("#invoiceno").trigger("focusout");
                }
            });
        }
    });
</script>

@*<script>
    var a =@Request.Params["Firm_Id"];

    $(document).ready(function () {
        $.ajax({
            type: "GET",
            url: "/Invoice/getFirm",
            data: "{}",
            success: function (data) {
                // var s = '<option value="-1">Please Select a Department</option>';
                var s;
                for (var i = 0; i < data.length; i++) {
                    s += '<option value="' + data[i].Firm_Id + '">' + data[i].Firm_Name + '</option>';
                }
                $("#departmentsDropdown").html(s);

                $("#departmentsDropdown").val(a);


            }



        });
    });


    </script>

    <script>
        $("#departmentsDropdown").change(function () {
            //var selectedStudentVal = $("#ddlStudent").val();
            //window.location.replace("/Invoice/GenerateInvoice?Firm_Id=" + selectedStudentVal);

            var departmentsDropdown = $("#departmentsDropdown").val();
            // window.history.pushState("null", "null", "/Invoice/GenerateInvoice?Firm_Id=" + departmentsDropdown);
            window.location.replace("/Invoice/ViewSingleInvoice?Firm_Id=" + departmentsDropdown);

            $("#departmentsDropdown").html(departmentsDropdown);
        });




    </script>*@



@*@if (TempData["error"] != null)
    {
        <script>
            //alert('@TempData["error"]');
        </script>
    }



    @if (TempData["success"] != null)
    {
        <script>
            //alert('@TempData["success"]');
        </script>
    }*@


<!-- Validation Script -->
<script>
    $(document).ready(function () {
        //$('#submitbook').on('click', function (e) {
        //    // Prevent form submission


        //    // Get values of the fields
        //    var companyDetails = $('#Companydetails').val().trim();

        //    var invoiceNo = $('#invoiceNo').val().trim();
        //    var invFromDate = $('#invfromdate').val().trim();
        //    var invToDate = $('#invtodate').val().trim();

        //    // Check if at least one of the fields is filled
        //    if (companyDetails === "" && invoiceNo === "" && (invFromDate === "" || invToDate === "")) {
        //        alert("Please select at least one: Company Name, Invoice Number, or From Date to To Date.");
        //        e.preventDefault();
        //        return false; // Stop the form submission
        //    }

        //    // If validation passes, submit the form
        //    $("#FormSubmitSingle").submit();
        //});
    });
</script>